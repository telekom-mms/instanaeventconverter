# InstanaEventConverter

### What is this?
This program listen on a port for "Instana" Events. The Events are send via Webhook to this converter.
The "InstanaEvents" will be analyzed and send to a External System checkmk

#requirements
jq
java-11
instana-api key and url


### How to build this (from source):
Build with maven "package"
In the "build" folder are all needed files
 * config/*
 * libs/*
 * openEvents/*
 * instanaEventConverter.jar
 * instanaEventConverter.sh
 
 
#servicesapplications.sh (depricated)
add api key and instana url here

#instanaEventconverter.sh
place correct java-11 path here
 
#created files
events.store: is created when events are opened and removed when they are closed
servicesapplications.json: is created during the startup

### Install
* install Java openJdk-11 "yum install java-11-openjdk-devel"
* copy the files in the build folder to your server
* edit the config.properties file if needed
* edit the log4j.properties file if needed
* rename directory "instanaEventconverter-bin" to "instanaEventconverter"
* sudo yum install jq
* allow the execution of the file instanEventconverter.sh
* chmod u+x /opt/instanaEventConverter/instanaEventConverter.sh
* chmod u+x /opt/instanaEventConverter/config/servicesapplications.sh
* execute instanaEventConverter.sh
* if there is anny https connection you need to add the cert to the truststore

### Usage

* You can send Events to the endpoint /
* You can send events direct when using /direct
* You can send events direct when using /instana

### Requirements
java 11 & libs

### New Features:
* read services and applications from instana direct instead of usage of jq
* vapplication as main connector between instana and checkmk
### Removed Feature:
* msend
* http for truesight
* now stores events with application and type


### Configuration
Set up a webhook in instana and point it to the server and port where this program is running


# config properties
# config properties
http_port=28080
https_port=18080
keystore_path=config/keystore.jks
keystore_pass=changeit
enable_ssl=false

#api none|snmp
api=snmp

event_class=INSTANA

#redirects requests from / to this endpoint
default_endpoint=instana

#snmpconfig
snmp_event_ip=<hostip>
#typical 162
snmp_event_port=<port typical 162>
#valid is 1 2c 3 3Command
snmp_version=1,2c,3 or 3Command>
snmp_oid=1.3.6.1
snmp_extra_oid=1.3.6.1.4.1
snmp_engineid=0000000000
#for snmp v3
snmp_securityname=testtest
snmp_authpassphrase=testtest
snmp_privpassphrase=testtest

#for snmo v3
snmp_authcypher=MD5
snmp_securitycypher=AES


## fieldmapping
here you can specify which fields will be mapped by default for the eventtype
Here you can definde the filds that will be send and you can rename them.
Definde a default value: "default"

You can enable or disable the eventtype for sending
Set Eventtyp to "active": true,

Set Mapping operation for not mapped fields 
Set: "addNotMappedKeys": false,


{
	"instana": "description",
	"converter": "msg",
	"concate": true,
	"default": "none"
},

## vservicemapping
a bit more complex, it is possible to map services in instana specially
Everthing has to match.

You can use the service name (converterAlias) from the field itself (value_is_servicename) or the name is taken from the converter_alias

"converter_alias": "My Alias Name for the service",
		"mapping_fields": [
			{
				"instana_field_key": "entity",
				"value_is_vservice_name": false,
				"instana_field_value": "InstanaEntity"
			},
			{	
				"instana_field_key": "entityLabel",
				"value_is_vservice_name": true,
				"instana_field_value": "notnull"
			}
			
		]


#special fields
vapplication: This field is set with mappings in the field servicesapplications.json. This is a 1:1 setting. Every service can be in multiple applications.
Every combination will result in a new external event
id: the id is unique identifier from instana


# serviceapplicationmapping.json
The List is generated by servicesapplications.sh the result is servicesapplications.json
The converter can map services and applications. In instana every service can have multiple application. 
The application field will be added to the event and it will be also send when closing the event.

# events.store
the file is used for storing eventid and application name

### Start InstanEventconverter
use the instanaEventConverter.sh start

### Stop InstanaEventtconverter
use the instanaEventConverter.sh stop

### Logging
StandardLog: There is a Standard Logfile in the log folder
EventLog: additionanlly we log all events in a special file

### License: 
Copyright 2023 Deutsche Telekom MMS GmbH (https://www.t-systems-mms.com/) 

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

### Author: 
Kay Koedel, kay.koedel@telekom.de
